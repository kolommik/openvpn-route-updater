# OpenVPN Route Updater

Скрипт для автоматического обновления маршрутов в конфигурации OpenVPN на основе DNS-запросов. Скрипт проверяет IP-адреса указанных доменов и добавляет новые маршруты в конфигурацию OpenVPN, сохраняя уже существующие.

## Возможности

- Автоматическое определение IP-адресов для заданных доменов
- Сохранение существующих маршрутов
- Добавление только новых маршрутов
- Группировка доменов с одинаковыми IP
- Создание резервных копий перед изменением конфигурации
- Автоматический перезапуск OpenVPN после обновления

## Требования

- Python 3.6+
- Установленный OpenVPN сервер на Ubuntu
- Права sudo для редактирования конфигурации и перезапуска службы

## Установка

1. Клонируйте репозиторий:
```bash
sudo git clone https://github.com/kolommik/openvpn-route-updater.git /opt/openvpn-route-updater
```

2. Настройте права:
```bash
sudo chmod +x /opt/openvpn-route-updater/update_routes.py
```

3. Подготовьте конфигурацию OpenVPN:
   Добавьте маркеры блока маршрутов в ваш конфиг OpenVPN (`/etc/openvpn/server/server.conf`):
```
# BEGIN ROUTE BLOCK
push "route 188.114.98.228 255.255.255.255"  # existing route
# END ROUTE BLOCK
```

## Настройка

Отредактируйте скрипт, изменив константы в начале файла:

```python
# Конфигурационные константы
CONFIG_PATH = "/etc/openvpn/server/server.conf"  # Путь к конфигу OpenVPN
BACKUP_DIR = "/etc/openvpn/server/backups"       # Директория для резервных копий
RESTART_COMMAND = "sudo systemctl restart openvpn-server@server"  # Команда перезапуска
DNS_SERVER = "1.1.1.1"  # DNS сервер для запросов

# Список доменов для проверки
DOMAINS = [
    "nerdvm.racknerd.com",
    "racknerd.com",
    "my.racknerd.com",
    # Добавьте ваши домены здесь
]
```

## Использование

### Ручной запуск

```bash
sudo python3 /opt/openvpn-route-updater/update_routes.py
```

### Настройка регулярного запуска через cron

Добавьте задание в crontab для автоматического запуска скрипта:

```bash
sudo crontab -e
```

Добавьте строку для запуска скрипта раз в 15 минут:

```
*/15 * * * * python3 /opt/openvpn-route-updater/update_routes.py >> /var/log/openvpn-route-updater.log 2>&1
```

## Логика работы

1. Скрипт читает конфигурацию OpenVPN и извлекает существующие маршруты
2. Выполняет DNS-запросы для указанных доменов и получает их IP-адреса
3. Сравнивает найденные IP с существующими маршрутами
4. Если обнаружены новые IP, создаёт резервную копию конфига
5. Обновляет блок маршрутов в конфигурации, сохраняя существующие и добавляя новые
6. Перезапускает OpenVPN для применения изменений

## Примечания

- Скрипт сохраняет все существующие маршруты, даже если они не соответствуют текущим доменам
- Для каждого IP создаётся только один маршрут с указанием всех соответствующих доменов
- При возникновении ошибок проверьте журнал и права доступа
